{% extends '::frontend.html.twig' %}
{% block title %}Ficheros {% endblock %}

{% block article %}

<script type="text/javascript">

	function borrarNodo(nodo,idfichero){
		//Calculo de si es el ultimo nodo
		var body=document.getElementById("tbody"); 
		var x=body.childNodes;
		var hijos=0;
		for (i=0;i<x.length;i++){
			if (x[i].tagName=="TR"){hijos+=1;}
		}
		
		//Obtiene nodo
		var child=document.getElementById(nodo);
		if (hijos==1){
		//Si es el ultimo nodo, lo borra pero crea uno vacio, ademas pone 0 archivos.
		child.innerHTML="<tr id='tr1'><th>...</th><th></th><th></th><th></th></tr>";
		document.getElementById("td_total_archivos").innerHTML="<span id='total_archivos'>0</span> archivos";
		}
		else{
		//Borra nodo
		child.parentNode.removeChild(child);
		if(hijos==2){
			//Si quedan 2 nodos, al borrar uno, quedara uno -> 1 archivo
			document.getElementById("td_total_archivos").innerHTML="<span id='total_archivos'>1</span> archivo";
			
		}else if(hijos>2){
			//Si quedan mas de 2 nodos, resta la cantiada de ficheros totales.
			var y=document.getElementById("total_archivos").innerHTML;
			document.getElementById("total_archivos").innerHTML=y-1;
		}
		}
		//falta peticion POST AJAX para eliminar fichero.
		
		$.get(idfichero);
	}
	

	
</script>

<section>
	<h1 id='titulo'>{{ block('title') }}</h1>
	<div class="tabla" id='itsthetable'>
	<table>
	<caption>{{ app.user.nombreusuario }}<a href="{{ path('ficheros') }}">/{{ ruta }}</a> <div style='float:right'><button id='button_subir'>Subir archivo</button> <button id='button_carpeta'>Crear carpeta</button></div></caption>

	<thead><tr><th style='width:80%;'>Nombre</th><th>Tama&ntilde;o</th><th>Modificado</th><th></th></tr></thead>
	<tbody id="tbody">
		{% set var1 = 0 %}
		{% for ficheros in ficheros %}
		
		{% set var1 = var1 + 1 %}

		<tr id="tr{{var1}}" {% if var1 is divisibleby(2) %} class="odd" {% endif %}>
			<th>
				{% if ficheros.tipo == 'carpeta' %}
					{% if ficheros.ruta == '/' %}
						<a href="{{ path('ficheros') }}{{ ['/',ficheros.nombrefichero]|join }}">{{ ficheros.nombrefichero }}/</a> 
					{% else %}
						<a href="{{ path('ficheros') }}{{ [ficheros.ruta,'/',ficheros.nombrefichero]|join }}">{{ ficheros.nombrefichero }}/</a> 
					{% endif %}
					
				{% else %}
					<a href="{{ path('descargar', { 'fichero': ficheros.idfichero }) }}">{{ ficheros.nombrefichero }}</a> 
				{% endif %}
			</th>
			<th style='text-align:right;'> {{ficheros.filesize}} Mb</th>
			<th>{{ ficheros.fechasubida|date('d-m-Y') }}</th>
			<th> 
				<a href="{{ path('modificar', { 'fichero': ficheros.idfichero }) }}"><img  alt="Editar" src="{{ asset('bundles/usuario/images/edit.png') }}"></a>
				<!-- <a href="{{ path('borrar', { 'fichero': ficheros.idfichero }) }}">  <img alt="Eliminar" src="{{ asset('bundles/usuario/images/delete.png') }}"></a> -->
				<a href="#" onclick="borrarNodo('tr{{var1}}','{{ path('borrar', { 'fichero': ficheros.idfichero }) }}')">  <img alt="Eliminar" src="{{ asset('bundles/usuario/images/delete.png') }}"></a> 
			</th>
		</tr>
		{% endfor %}
		{% if var1 == 0 %}<tr><th><a href="{{ app.request.getRequestURI() }}/../"/>../</a></th><th></th><th></th><th></th></tr>{% endif %}
	</tbody>
	<tfoot><tr><th>Total</th><td colspan="4" id="td_total_archivos"><span id='total_archivos'>{{var1}}</span> archivos</td></tr></tfoot>
	</table>
	</div>	

	<div id='file_upload' class='div_amagado'>
		<table class='no_class'>
			<tr>
					<form action="{{ path('subir') }}" method="POST" {{ form_enctype(formulario) }}>
						{{ form_errors(formulario) }}
						<td>{{ form_row(formulario.file) }} </td>
						<td><input type="submit" value="Subir" /></td>
						<td>{{ form_row(formulario.ruta) }}{{ form_rest(formulario) }}</td>
					</form>
					<td><button id='cerrar_file_upload'>Cerrar</button></td>
			</tr>
		</table>
	</div>
	
	<div id='crear_carpeta' class='div_amagado'>
		<table class='no_class'>
			<tr>
				<form action="{{ path('subir') }}" method="POST" {{ form_enctype(formulario_carpeta) }}>
					{{ form_errors(formulario_carpeta) }}
					<td>{{ form_row(formulario_carpeta.nombrefichero) }}</td>
					<td><input type="submit" value="Crear" /></td>
					<td>{{ form_rest(formulario_carpeta) }}</td>
				</form>
				<td><button id='cerrar_crear_carpeta'>Cerrar</button></td>
			</tr>
		</table>
	</div>
	
	
	<script>
		$(document).ready(function(){
		  $("#button_subir").click(function(){
			$("#itsthetable").fadeTo("slow",0.15);
			$("#crear_carpeta").hide();
			$("#file_upload").show();
			var xhr_ocupado = $.get( "api/perfil/ocupado", function( datos ) {
				//alert(datos);
			});
			
			
		  });
		  $("#button_carpeta").click(function(){
			$("#itsthetable").fadeTo("slow",0.15);
			$("#file_upload").hide();
			$("#crear_carpeta").show();
		  });
		  $("#cerrar_file_upload").click(function(){
			$("#crear_carpeta").hide();
			$("#file_upload").hide();
			$("#itsthetable").fadeTo("slow",1);
		  });
		  $("#cerrar_crear_carpeta").click(function(){
			$("#crear_carpeta").hide();
			$("#file_upload").hide();
			$("#itsthetable").fadeTo("slow",1);
		  });
		});
	</script>
</section>
{% endblock %}